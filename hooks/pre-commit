#!/bin/bash
# Pre-commit hook to prevent non-ASCII characters in committed files

set -e

echo "Checking for non-ASCII characters in staged files..."

# Get all staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

NON_ASCII_FOUND=false

for file in $STAGED_FILES; do
    # Skip binary files and certain file types
    if file "$file" | grep -q "binary"; then
        continue
    fi
    
    # Check if file contains non-ASCII characters
    if grep --color='auto' -P -n "[\x80-\xFF]" "$file" > /dev/null 2>&1; then
        if [ "$NON_ASCII_FOUND" = false ]; then
            echo ""
            echo "Error: Non-ASCII characters detected in the following files:"
            NON_ASCII_FOUND=true
        fi
        echo ""
        echo "File: $file"
        grep --color='auto' -P -n "[\x80-\xFF]" "$file" | head -5
        echo "(showing first 5 occurrences)"
    fi
done

if [ "$NON_ASCII_FOUND" = true ]; then
    echo ""
    echo "Please remove non-ASCII characters and try again."
    exit 1
fi

echo "No non-ASCII characters found"
exit 0
